<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.105.1/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.105.1/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

  <link rel="stylesheet" href="https://smartcity.tacc.utexas.edu/FireIncident/Demo3D/assets/css/fireMap.css">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/cesium-plugin/cesium-popup-es6@main/dist/cesium-popup-es6.umd.js"></script>


  <link rel="preload" href="https://smartcity.tacc.utexas.edu/FireIncident/assets/fonts/ManifoldDSA/ManifoldDSA-Medium.woff" as="font" type="font/woff" crossorigin="">
  <link rel="preload" href="https://smartcity.tacc.utexas.edu/FireIncident/assets/fonts/ManifoldDSA/ManifoldDSA-ExtraBold.woff" as="font" type="font/woff" crossorigin="">
  <link rel="preload" href="https://smartcity.tacc.utexas.edu/FireIncident/assets/fonts/FontAwesome/fa-solid-900.woff" as="font" type="font/woff" crossorigin="">
</head>
<style>
    html,
body,
#cesiumContainer {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden;
}
.earth-popup-common1 {
    position: absolute;
    background: #fff;
    border-radius: 3px;
    box-shadow: 0 1px 2px rgba(0,0,0,.1);
    padding: 10px 10px 15px;
    pointer-events: auto;
    line-height: 1.4;
    border-radius: 10px;
    max-width: 240px;
    max-width: 252px;
    /* background: white; */
    color: #333;
    /* box-shadow: 0 3px 14px rgb(0 0 0 / 40%); */
    text-align: left;
    border-radius: 12px;
    /*font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;*/
}
.earth-popup-common1:after {
    display: inline-block;
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 10px;
    height: 0;
    border: 5px solid transparent;
    border-top: 8px solid #fff;
    content: "";
}
.mapboxgl-popup-close-button {
    position: absolute;
    right: 0;
    top: 0;
    border: 0;
    border-radius: 0 3px 0 0;
    cursor: pointer;
    background-color: transparent;
}
.mapboxgl-popup-tip {
    -webkit-flex-direction: column-reverse;
    flex-direction: column-reverse;
    -webkit-align-self: center;
    align-self: center;
    border-bottom: none;
    border-top-color: #fff;
    margin-top: -1px;
    width: 0;
    height: 0;
    border: 10px solid transparent;
    z-index: 1;
}
#cesiumContainer {
    position: absolute;
    left: 0;
}

.sidebar {
    position: absolute;
    width: 340px; 
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    text-align: center; 
    font-family: Arial, sans-serif;
    transition: transform 0.3s ease-in-out;
}

.sidebar.closed {
    transform: translateX(-89%);
}

.sidebar.open {
    transform: translateX(0);
}

.header {
    padding: 20px;
}

.header h1 {
    font-size: 1.5em;
    margin-bottom: 10px;
}

.header p {
    font-size: 0.9em;
    color: #888;
}

.sidebar-toggle {
    position: absolute;
    left: 0;
    top: 0;
    background: none;
    border: none;
    font-size: 2em;
    transition: left 0.3s ease-in-out;
}

.sidebar-toggle.open {
    left: 300px;
}



</style>


<body>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <div id="cesiumContainer" style="position: absolute;"></div>
    <div id="sidebar" class="sidebar closed">
        <!-- Place your sidebar content here -->
        <div class="header">
            <h1><i class="fas fa-city"></i> Austin Digital Twin</h1>
            <p>Work in progress</p>
        </div>
    </div>
    <button id="sidebar-toggle" class="sidebar-toggle"><i class="fas fa-bars"></i></button>
    
    
    
  <script>

document.getElementById('sidebar-toggle').addEventListener('click', function() {
    var sidebar = document.getElementById('sidebar');
    var button = document.getElementById('sidebar-toggle');
    if (sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        button.classList.remove('open');
    } else {
        sidebar.classList.add('open');
        button.classList.add('open');
    }
});


    // Your access token can be found at: https://ion.cesium.com/tokens.
    // This is the default access token from your ion account

    // Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3ODhiN2NhYi02NzgxLTQ2OWQtOTAzMi02ZTgwYmNjMGJmYjYiLCJpZCI6MTM4NjUzLCJpYXQiOjE2ODQxMTUyNDV9.yzVSoiedb3diO7rOG9kd9Luuamx4Wjnieson-zb3vvk';

    // // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
    // const viewer = new Cesium.Viewer('cesiumContainer', {
    //   terrainProvider: Cesium.createWorldTerrain()
    // });    
    // // Add Cesium OSM Buildings, a global 3D buildings layer.
    // const buildingTileset = viewer.scene.primitives.add(Cesium.createOsmBuildings());   

    
        Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3ODhiN2NhYi02NzgxLTQ2OWQtOTAzMi02ZTgwYmNjMGJmYjYiLCJpZCI6MTM4NjUzLCJpYXQiOjE2ODQxMTUyNDV9.yzVSoiedb3diO7rOG9kd9Luuamx4Wjnieson-zb3vvk";

        Cesium.GoogleMaps.defaultApiKey = "AIzaSyDV0rBF5y2f_xsSNj32fxvhqj3ZErTt6HQ";

        const viewer = new Cesium.Viewer("cesiumContainer", {
            globe: false,
        });


    async function createGooglePhotorealistic3DTileset() {
        try {
        const tileset = await Cesium.createGooglePhotorealistic3DTileset();
        window.tileset = tileset;
        viewer.scene.primitives.add(tileset);

        //plotPoint(tileset, 30.285337, -97.7397203);

        fetchAllData();
        //fetchPurpleAirData();

        } catch (error) {
        console.log(`Failed to load tileset: ${error}`);
        }
    }


    createGooglePhotorealistic3DTileset();

    function addMore() {
        console.log("hey")
        var moreButton = document.getElementById("moreButton");
        
        if(moreButton.textContent == "More...") {
        document.getElementById("more").style.display = "block";
        document.getElementById("moreButton").textContent = "Less...";
        } else {
        document.getElementById("more").style.display = "none";
        document.getElementById("moreButton").textContent = "More...";
        }
        //airMarkerPopup += `<a href="#">More...</a>`
    }

async function plotPoint(tileset, lat, lng, fireData) {
    console.log(tileset, lat, lng, fireData)
    // Get position from lat/lon
    const position = Cesium.Cartesian3.fromDegrees(lng, lat, 10000); // Assume initial altitude of 10,000m

    // Cast a ray from position to the center of the Earth
    const ray = new Cesium.Ray(position, Cesium.Cartesian3.negate(Cesium.Cartesian3.fromDegrees(lng, lat), new Cesium.Cartesian3()));
    
    // Intersect the ray with the tileset
    const intersection = viewer.scene.pickFromRay(ray, [tileset]);

    if (Cesium.defined(intersection)) {
        const clampPosition = intersection.position;
        // Subtract 10m from the altitude so the billboard does not clip into the ground
        clampPosition.z -= 30;
        clampPosition.y += 30;
        clampPosition.x += 20;

        // Add the billboard
        let billboardEntity = viewer.entities.add({
            position: clampPosition,
            billboard: {
                image: 'https://smartcity.tacc.utexas.edu/FireIncident/assets/images/fire.png',
                //verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                scale: 0.1,
                // Allow see through everything by doing allowing any depth
                pixelSize: 10,
                outlineWidth: 3,

                verticalOrigin: Cesium.VerticalOrigin.CENTER,
                // Disable depth testing so the billboard will not be occluded by terrain
                disableDepthTestDistance: Number.POSITIVE_INFINITY,
            },
            // Instead of a billboard, you can add a marker pin
            // point: {
            //     // with the image of a pin
            //     color: Cesium.Color.WHITE,
            //     pixelSize: 10,
            //     outlineColor: Cesium.Color.WHITE,
            //     outlineWidth: 3,
            //     disableDepthTestDistance: Number.POSITIVE_INFINITY,
            // }

        });



        let billboardId = billboardEntity.id;

const action = {
    remove: (popup) => {
        console.log(popup, "The popup was removed");
        // Translate to english: "The popup was removed"
    },
    onChange: (popup) => {
        console.log(popup, "The popup was moved");
        // Translate to english: "The popup was moved"
    },
    editAttr: (popup) => {
        console.log(popup, "The popup needs to edit attributes！");
        // Translate to english: "The popup needs to edit attributes"
        popup.setContent("My content has been changed！")
        // Translate to english: "My content has been changed!"
    }
}

console.log(fireData);
let link = fireData.link;
let longNLatString = link.replace('http://maps.google.com/maps?q=', '');
url = 'https://api.weather.gov/points/' + longNLatString;


var response = await fetch(url);
var api = await response.json();
var hourlyApiUrl = api.properties.forecastHourly;
var response = await fetch(hourlyApiUrl);
var hourlyData = await response.json();
hourlyData1 = hourlyData.properties.periods[0];

let handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
handler.setInputAction(function(click) {
    let pickedObject = viewer.scene.pick(click.position);
    if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id) && pickedObject.id.id === billboardId) {
        // Billboard was clicked
        // Create a popup
        //const cartesian33 = Cesium.Cartesian3.fromDegrees(103.6633339676296, 36.090254266492465, 1522.8186244347767)
        // Just use clampPosition as the position of the popup
        const cartesian33 = clampPosition;
        const html3 = `
        <button class="mapboxgl-popup-close-button" type="button" aria-label="Close popup">×</button>
        <div>
            <span>
        <div style="
            font-size: xx-large;
            font-family: sans-serif;
            text-align: center;
            border-color: green;
            border-radius: 20px;
            color: black;
        ">
        <div class="location-info"> <span>${fireData.title}</span><BR>
        </div>
        </div>
            Location: ${fireData.description.split('|')[0]}<br>
            Publish Date: ${fireData.pubDate}<br>
            <a id="moreButton" href="#" onclick="addMore()">More...</a>
            <div id="more" style="display:none">
                Temperature: ${hourlyData1.temperature}℉<br>
                Forecast: ${hourlyData1.shortForecast}<br>
                Wind Speed: ${hourlyData1.windSpeed}<br>
                Wind Direction: ${hourlyData1.windDirection}<br>
            </div>
        </div>
        `;
        var newpopup = new CesiumPopup(viewer, {
            position: cartesian33, 
            html: html3, 
            className: "earth-popup-common1", 
            popPosition: "bottom"
        }, action)
        // Attach a close event to the button in the popup
        document.querySelector('.mapboxgl-popup-close-button').addEventListener('click', () => {
            newpopup.remove();
        });
        // Clicking anywhere off the popup when it is open will close it
        viewer.screenSpaceEventHandler.setInputAction(() => {
            newpopup.remove();
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    } 
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);



    } else {
        console.log('No intersection found');
        // Do it again in 1 second
        setTimeout(() => plotPoint(tileset, lat, lng, fireData), 1000);

    }
}



var originalPosition = Cesium.Cartesian3.fromDegrees(-97.739720, 30.285337);

// You will need to adjust these values to suit your needs.
var offset = new Cesium.Cartesian3(-250, -80, -200); // Adjust this offset to get the right position.
var position = Cesium.Cartesian3.add(originalPosition, offset, new Cesium.Cartesian3());

var hpr = new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(90), Cesium.Math.toRadians(0), Cesium.Math.toRadians(0));
var orientation = Cesium.Transforms.headingPitchRollQuaternion(position, hpr);

var entity = viewer.entities.add({
    position : position,
    orientation : orientation,
    model : {
        uri : '30.285337,-97.7397203.glb',
        minimumPixelSize : 12,
        maximumScale : 20,
        scale : 0.005,
        color: new Cesium.Color(0, 0, 0, 0.9), // Black color with 0.5 alpha
        colorBlendMode : Cesium.ColorBlendMode.MIX,
        colorBlendAmount : 0.5,
        //silhouetteColor : Cesium.Color.RED,
        //silhouetteSize : 2.0,
        opacity : 0.4,
    }
});


function fetchAllData() {

// Use the Fetch API to get the data
fetch('https://smartcity.tacc.utexas.edu/FireIncident/data/2022-08-08-FireMap.json')
    .then(response => response.json())
    .then(data => {
        // data now contains the JSON data from the URL

        // Parse the data
        let items = data.rss.channel.item;
        console.log(items);

        // Loop over each item
        for (let item of items) {
            // Get the link to the .fbx file
            let link = item.link;
            console.log(link);
            // replace http://maps.google.com/maps?q= with nothing
            let latLng = link.replace("http://maps.google.com/maps?q=", "");
            let [lat, lng] = latLng.split(",");
            console.log(lat, lng);

            // plot the fire on the map
            plotPoint(window.tileset, parseFloat(lat), parseFloat(lng), item);
            
            // load and display the fbx file
            //let modelUrl = `https://smartcity.tacc.utexas.edu/FireIncident/data/generated/${latLng}.fbx3`;
            //console.log(modelUrl);
            let modelUrl = `${latLng}.glb`;
            //let modelUrl = `30.285337,-97.7397203.glb`;
            let position = Cesium.Cartesian3.fromDegrees(parseFloat(lng), parseFloat(lat));
            let offset = new Cesium.Cartesian3(-250, -80, -200); 
            let finalPosition = Cesium.Cartesian3.add(position, offset, new Cesium.Cartesian3());
            let hpr = new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(90), Cesium.Math.toRadians(0), Cesium.Math.toRadians(0));
            let orientation = Cesium.Transforms.headingPitchRollQuaternion(finalPosition, hpr);

            viewer.entities.add({
                position : finalPosition,
                orientation : orientation,
                model : {
                    uri : modelUrl,
                    minimumPixelSize : 12,
                    maximumScale : 20,
                    scale : 0.005,
                    color: new Cesium.Color(0, 0, 0, 0.9),
                    colorBlendMode : Cesium.ColorBlendMode.MIX,
                    colorBlendAmount : 0.5,
                    opacity : 0.4,
                }            
            })

        }
    })
    .catch(error => {
        console.error('Error:', error);
    });

    mapPurpleAirData(window.tileset);



}


    function graphPurpleAirPoint(sensorKey, lat, lng, color, description,tileset) {
        console.log(sensorKey, lat, lng, color, description);
        console.log(tileset)
        // const position = Cesium.Cartesian3.fromDegrees(lng, lat, 1000); // Assume initial altitude of 10,000m

        // // Cast a ray from position to the center of the Earth
        // const ray = new Cesium.Ray(position, Cesium.Cartesian3.negate(Cesium.Cartesian3.fromDegrees(lng, lat), new Cesium.Cartesian3()));

        // // Intersect the ray with the tileset
        // const intersection = viewer.scene.pickFromRay(ray, [tileset]);

        // if (Cesium.defined(intersection)) {
        //     const clampPosition = intersection.position;
        //     // Subtract 10m from the altitude so the billboard does not clip into the ground
        //     clampPosition.z -= 30;
        //     clampPosition.y += 30;
        //     clampPosition.x += 20;



            viewer.entities.add({
//                position: clampPosition,
                position: Cesium.Cartesian3.fromDegrees(lng, lat,150),
                billboard: {
                    image: './circle.png',  // You should create and use a circular image
                    color: Cesium.Color.fromCssColorString(color),
                    scale: 0.05, // This will need to be adjusted
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY,
                },
                id: sensorKey
            });

        //}
        // else {
        //     console.log('No intersection found');
        //     // Do it again in 1 second
        //     //setTimeout(() => graphPurpleAirPoint(sensorKey, lat, lng, color, description,tileset));
        // }
    }


    var runGetPurpleAirOnce = false;
    var runGetMicrosoftAirOnce = false;
    var airData = [];

    async function mapPurpleAirData(tileset) {

        if (runGetPurpleAirOnce) {
            return;
        }
        runGetPurpleAirOnce = true;

        let sampleData = [
            {
                "link": "https://map.purpleair.com/1/mAQI/a10/p604800/cC0?key=4Z0L6SM6TMMYSTX0&select=27519#14/30.28559/-97.73693",
                "active_status": "yes"
            },
            {
                "link": "https://map.purpleair.com/1/mAQI/a10/p604800/cC0?key=4Z0L6SM6TMMYSTX0&select=27569#13.69/30.28233/-97.72709",
                "active_status": "yes"
            },
        ];


        if(airData.length == 0) {
            let cities = {
                // Cities with northwest latitude, southwest latitude, northwest longitude, southwest longitude
                "":[30.747879,29.978325,-98.056977,-97.357011],
            };

            rawwData = [];

            for(city in cities) {
                let latlng = cities[city];
                let jsonUrl = 'https://api.purpleair.com/v1/sensors?api_key=81D9ACDC-966F-11EC-B9BF-42010A800003&nwlat=' + 
                latlng[0] + '&selat=' + latlng[1] + '&nwlng=' + latlng[2] + '&selng=' + latlng[3] + '&fields=latitude,longitude,altitude,pm2.5_10minute';
                let response = await fetch(jsonUrl);
                let currentData = await response.json();

                rawwData = rawwData.concat(currentData.data);
            }
            airData = rawwData;

            console.log(airData);

        }


        // Add billboards for each air quality data point
        for (let i = 0; i < airData.length; i++) {
            let data = airData[i];
            let sensorKey = data[0];
            let longNLatArray = [data[1], data[2]]; //fetched like [index,long,lat,alt,pm25]...
            var pm10Mins = data[4];
            let colorNDes = getPMDescription(pm10Mins)
            var color = colorNDes[0];
            var description = colorNDes[1];
            
            let lat = longNLatArray[0];
            let lng = longNLatArray[1];

            graphPurpleAirPoint(sensorKey, lat, lng, color, description,tileset);

        }

// Declare newpopup outside of the setInputAction
let newpopup = null;

// Separate event handler for closing popups
let closePopupHandler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
closePopupHandler.setInputAction(() => {
    if (newpopup) {
        newpopup.remove();
        newpopup = null;
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

viewer.screenSpaceEventHandler.setInputAction(function (event) {
    var pickedObjects = viewer.scene.drillPick(event.position);
    for (let i = 0; i < pickedObjects.length; i++) {
        if (pickedObjects[i].primitive instanceof Cesium.Billboard) {
            let sensorKey = pickedObjects[i].primitive.id._id;
            console.log(sensorKey);
            let airApiUrl = 'https://api.purpleair.com/v1/sensors/' + sensorKey + '?api_key=81D9ACDC-966F-11EC-B9BF-42010A800003';
            fetch(airApiUrl).then((response) => {
                return response.json();
            }).then((data) => {
                console.log(data);
                var description = "";  
                try {
                var popupHtml = buildAirDataPopup(pickedObjects[i].primitive, data.sensor, description);
                } catch {
                    console.log("error")
                    return
                }
                const action = {
                    remove: (popup) => {
                        console.log(popup, "The popup was removed");
                    },
                    onChange: (popup) => {
                        console.log(popup, "The popup was moved");
                    },
                    editAttr: (popup) => {
                        console.log(popup, "The popup needs to edit attributes！");
                        popup.setContent("My content has been changed！")
                    }
                }
                
                // If a popup already exists, remove it
                if (newpopup) {
                    newpopup.remove();
                }

                // Create a new popup and store its reference
                newpopup = new CesiumPopup(viewer, {
                    position: pickedObjects[i].primitive.position, 
                    html: popupHtml, 
                    className: "earth-popup-common1", 
                    popPosition: "bottom"
                }, action);

                // Close the popup if the close button is clicked
                document.querySelector('.mapboxgl-popup-close-button').addEventListener('click', () => {
                    if (newpopup) {
                        newpopup.remove();
                        newpopup = null;
                    }
                });
                
                // Stop the event propagation
                //event.stopImmediatePropagation();
            });
        }
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);



        function buildAirDataPopup(marker, popupData, description) {
        // console.log(popupData);

        var sensorKey = popupData.sensor_index; //sensor index

        description = getPMDescription(popupData.stats["pm2.5_10minute"])[1];

        let unixTimestamp = popupData.last_modified;
        var a = new Date(unixTimestamp * 1000);
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var year = a.getFullYear();
        var month = months[a.getMonth()];
        var date = a.getDate();
        var time = month + ' ' + date + ', ' + year;

        var airMarkerPopup = `
        <button class="mapboxgl-popup-close-button" type="button" aria-label="Close popup">×</button>
        <span>
        <div style="
            font-size: xxx-large;
            font-family: sans-serif;
            text-align: center;
            border-color: green;
            border-radius: 20px;
            color: black;
        ">${popupData.stats["pm2.5_10minute"]}
        </div>
        <b>
        ${description} 
        `;

        // insert bold ending brace at end of colon
        //airMarkerPopup.replace(":", ":</b>");
        // Get length of Pm2.5_10minute
        var pmLength = popupData.stats["pm2.5_10minute"].toString().length;

        airMarkerPopup += `
        <span style="
            font-size: small;
            color: grey;
            position: absolute;
            top: 50px;
            right: 10px;
        "> μg/m <sup>3</sup>
        </span>`

        airMarkerPopup += `</div>`;

        airMarkerPopup += buildAirTable(popupData.stats);

        airMarkerPopup += `<a id="moreButton" href="#" onclick="addMore()">More...</a>`

        airMarkerPopup += `<div id="more" style="display:none">
        <div class="air-info">
        <span><b>Time:</b> ${time} </span><BR>
        <span><b>Latitude:</b> ${popupData.latitude} </span><BR>
        <span><b>Longitude:</b> ${popupData.longitude} </span><BR>
        <span><b>Altitude:</b> ${popupData.altitude} </span><BR>
        </div>
        `;

        console.log(airMarkerPopup);

        // Clear the current click event
        //marker.on('click', function (e) {});

        //marker.bindPopup(airMarkerPopup, {
        //    maxWidth : 201
        //});;
        //document.getElementById(sensorKey).innerHTML = airMarkerPopup;
        return airMarkerPopup;
        //console.log("got far")
        //marker.openPopup();
        //if (marker.getPopup())
        //    console.log("got popup")
        // No marker is popping up, fix this
        // marker.on('click', function (e) {
        //     console.log("clicked on marker " + sensorKey)
        //     // Check if marker has popup
        //     if (marker.getPopup()) {
        //         // If it does, close it
        //         marker.closePopup();

    }

    // build air table for next 5 hours
    function buildAirTable(pmData) {
        // console.log(pmData);
        var data = `
                <tr>
                    <td>${pmData["pm2.5"]}</td>
                    <td>${pmData["pm2.5_10minute"]}</td>
                    <td>${pmData["pm2.5_30minute"]}</td>
                    <td>${pmData["pm2.5_60minute"]}</td>
                    <td>${pmData["pm2.5_6hour"]}</td>
                    <td>${pmData["pm2.5_24hour"]}</td>
                    <td>${pmData["pm2.5_1week"]}</td>
                </tr>
                `;


        var table = `
        <table style="
        border-collapse: collapse;
        margin: 15px 0;
        font-size: 0.9em;
        font-family: sans-serif;
        min-width: 210px;
        min-height: 30px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    ">
        <thead style="
        text-align: center;
        padding: 10px 40px;
        font-size: smaller;
        background-color: #009375;
        color: #ffffff;
        text-align: center;
    ">
            <tr>
                <th>Now</th>
                <th>10 Min</th>
                <th>30 Min</th>
                <th>1 hr</th>
                <th>6 hr</th>
                <th>1 Day</th>
                <th>1 Week</th>
            </tr>
        <thead>
        <tbody>
            ${data}
        </tbody>
        <table/>
        `;
        return table;
    }


        function getPMDescription(pm10Mins, AQI = false) {
            let description = "";
            let color = "";
            if ((AQI && pm10Mins <= 50) || pm10Mins <= 12) {
                color = '#00e400';
                description = '<span>0-12: Air quality is satisfactory, and air pollution poses little or no risk with 24 hours of exposure.</span><BR>';
            } else if ((AQI && pm10Mins <= 100) || pm10Mins <= 35) {
                color = '#fdff01';
                description = '<span>12.1-35.4: Air quality is acceptable. However, there may be a risk for some people with 24 hours of exposure, particularly those who are unusually sensitive to air pollution.</span><BR>';
            } else if ((AQI && pm10Mins <= 150) || pm10Mins <= 55) {
                color = '#ff7e01';
                description = '<span>35.5-55.4: Members of sensitive groups may experience health effects. The general public is less likely to be affected.</span><BR>';
            } else if ((AQI && pm10Mins <= 200) || pm10Mins <= 150) {
                color = '#ff0100';
                description = '<span>55.5-150.4: Some members of the general public may experience health effects: members of sensitive groups may experience more serious health effects.</span><BR>';
            } else if ((AQI && pm10Mins <= 300) || pm10Mins <= 250) {
                color = '#8f3f97';
                description = '<span>150.5-250.4: Health Alert: The risk of health effects is increased for everyone.</span><BR>';

            } else if ((AQI && pm10Mins <= 301) || pm10Mins <= 350) {
                color = '#7e0023';
                description = '<span>250.5-350.4: Health Warning: Health warning of emergency conditions: everyone is more likely to be affected.</span><BR>';

            } else {
                color = '#7e0023';
                description = '<span>>=350.5: Health Warning: Health warning of emergency conditions: everyone is more likely to be affected.</span><BR>';

            }
            return [color, description];
        }

    }











// fly camera to model
viewer.flyTo(entity, {
    offset : new Cesium.HeadingPitchRange(0.0, -0.5, 2000.0)
});


    // Fly the camera to Austin, Texas at the given longitude, latitude, and height.
    // viewer.camera.flyTo({
    //   destination : Cesium.Cartesian3.fromDegrees(-97.7431, 30.2672, 1000.0),
    //   orientation : {
    //     heading : Cesium.Math.toRadians(0.0),
    //     pitch : Cesium.Math.toRadians(-15.0),
    //   }
    // });

    

    var scene = viewer.scene;
    var canvas = viewer.canvas;
    var handler = new Cesium.ScreenSpaceEventHandler(canvas);
    var annotations = scene.primitives.add(new Cesium.LabelCollection());


    // handler.setInputAction(function(movement) {
    //     // Add annotation showing the height at the click location
    //     var feature = scene.pick(movement.position);
    //     console.log(movement.position)
    //     if (Cesium.defined(feature) && scene.pickPositionSupported) {
    //         var cartesian = scene.pickPosition(movement.position);
    //         console.log(cartesian)
    //         var cartographic = Cesium.Cartographic.fromCartesian(cartesian);
    //         console.log(cartographic)
    //         var height = cartographic.height.toFixed(2) + ' m';

    //         annotations.add({
    //             position : cartesian,
    //             text : height,
    //             horizontalOrigin : Cesium.HorizontalOrigin.LEFT,
    //             verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
    //             eyeOffset : new Cesium.Cartesian3(0.0, 0.0, -1.0)
    //         });
    //     }


    // }, Cesium.ScreenSpaceEventType.LEFT_CLICK);


    // Make a function that takes in latlng coordinates and plots them on the map
    // async function plotPoint(lat, lng) {

    //     // Plot a point using 3D Tiles ClampToGround
    //     // Just make a marker with logo 'https://smartcity.tacc.utexas.edu/FireIncident/assets/images/fire.png',
    //     // at the given latlng coordinates



    //     // Make a Cesium billboard
    //     // var billboards = viewer.scene.primitives.add(new Cesium.BillboardCollection());

        
    //     // // Add a billboard with the given latlng coordinates
    //     // var cartesian = Cesium.Cartesian3.fromDegrees(lng, lat);

    //     // positions = []

    //     // Clamptoheight
    //     // scene.postRender.addEventListener(async function () {
    //     //     var yay = await viewer.scene.clampToHeightMostDetailed(cartesian);
    //     //     //var yay = scene.clampToHeight(cartesian);
    //     //     //console.log(hey);
    //     //     console.log(yay);

    //     //     // Add billboard, dont add again if already added
    //     //     if(yay == undefined || positions.includes(lat + "," + lng)) {
    //     //         console.log("already added");
    //     //         return;
    //     //     }

    //     //     billboards.add({
    //     //         position : yay,
    //     //         image : 'https://smartcity.tacc.utexas.edu/FireIncident/assets/images/fire.png',
    //     //         scale : 0.1,
    //     //         show: true, // default
    //     //         disableDepthTestDistance : Number.POSITIVE_INFINITY,
    //     //         clampToGround: true
    //     //     });

    //     //     viewer.entities.add({
    //     //         position : yay,
    //     //         label : {
    //     //             text : 'Fire Incident',
    //     //             font : '14pt monospace',
    //     //             style: Cesium.LabelStyle.FILL_AND_OUTLINE,
    //     //             outlineWidth : 2,
    //     //             verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
    //     //             pixelOffset : new Cesium.Cartesian2(0, -9)
    //     //         },
    //     //         clampToGround: true
    //     //     });

    //     //     positions.push(lat + "," + lng);

    //     // });
    

    //     // Use Cesium.sampleTerrainMostDetailed to get the height of the terrain at the given latlng coordinates
    //     // var height = Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [position]).then(function(updatedPositions) {
    //     //     console.log(updatedPositions[0].height);
    //     //     return updatedPositions[0].height;
    //     // });

    //     // height is still a promise, so we need to await it
    //     // height = await height;
    //     // console.log(height);

    // }

    // remove all cesium UI
    // classes include cesium-viewer-bottom, cesium-viewer-toolbar, cesium-viewer-animationContainer, cesium-viewer-timelineContainer
    // cesium-viewer-fullscreenContainer, cesium-viewer-geocoderContainer, cesium-viewer-home-button, cesium-viewer-baseLayerPicker
    // cesium-viewer-infoBoxContainer, cesium-viewer-selectionIndicatorContainer, cesium-viewer-navigationHelpButton
    // cesium-viewer-creditsContainer, cesium-viewer-cesiumCreditContainer
    document.getElementsByClassName("cesium-viewer-toolbar")[0].style.display = "none";
    document.getElementsByClassName("cesium-viewer-animationContainer")[0].style.display = "none";
    document.getElementsByClassName("cesium-viewer-timelineContainer")[0].style.display = "none";
    document.getElementsByClassName("cesium-viewer-fullscreenContainer")[0].style.display = "none";
    document.getElementsByClassName("cesium-viewer-geocoderContainer")[0].style.display = "none";
    document.getElementsByClassName("cesium-viewer-infoBoxContainer")[0].style.display = "none";
    document.getElementsByClassName("cesium-viewer-selectionIndicatorContainer")[0].style.display = "none";




  </script>
 </div>
</body>
</html>